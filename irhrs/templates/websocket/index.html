<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>


<button id="join">Join As User</button>
<button id="clear">Clear All Message</button>
<br><br>
<div id="echo_bar" hidden>
    UserID: <input type="text" name="user_id" id="user_id" placeholder="User ID">
    <button id="echo">Test Echo</button>
</div>
<hr>
<div>
    <input type="text" name="username" id="username" placeholder="username"/>
    <input type="password" name="password" id="password" placeholder="password"/>
    <button id="login">Login</button><br>
    Token: <span id="token">Not Logged In</span>
</div>
<hr>
<div>
    <input type="text" name="organization_slug" id="org_slug" placeholder="organization slug"/>
    <button id="subscribe_organization">Subscribe organization</button>
    <button id="unsubscribe_organization">Unsubscribe organizations</button><br>
    Subscribed to: <span id="subscribed_to">Not subscribed</span>
</div>
<script>
    var TOKEN = null;

    $("#echo").click(function () {
        let user_id = $('#user_id').val()
        if (user_id === '') {
            alert("Enter UserID")
        }
        $.get("echo/?user_id="+user_id, function (data, status) {
            console.log("Done ECHO");
        });
    });
    $('#clear').click(function () {
        var msgdiv = $("#messages")
        msgdiv.html("")
        console.log("Cleared out all message");
    });
    $("#login").click(function () {
        $.post("/api/v1/auth/obtain/", {
            "username": $("#username").val(),
            "password": $("#password").val()
        }).then(function (response) {
            TOKEN = response.token.access;
            $("#token").text(TOKEN);
        }).catch(() => {
            alert("Invalid Login")
        })
    })

    function get_token() {
        return TOKEN
    }

</script>
<hr>
<br><br>
<div id="messages"></div>
</body>
<script>
    !function (a, b) {
        "function" == typeof define && define.amd ? define([], b) : "undefined" != typeof module && module.exports ? module.exports = b() : a.ReconnectingWebSocket = b()
    }(this, function () {
        function a(b, c, d) {
            function l(a, b) {
                var c = document.createEvent("CustomEvent");
                return c.initCustomEvent(a, !1, !1, b), c
            }

            var e = {
                debug: !1,
                automaticOpen: !0,
                reconnectInterval: 1e3,
                maxReconnectInterval: 3e4,
                reconnectDecay: 1.5,
                timeoutInterval: 2e3
            };
            d || (d = {});
            for (var f in e) this[f] = "undefined" != typeof d[f] ? d[f] : e[f];
            this.url = b, this.reconnectAttempts = 0, this.readyState = WebSocket.CONNECTING, this.protocol = null;
            var h, g = this, i = !1, j = !1, k = document.createElement("div");
            k.addEventListener("open", function (a) {
                g.onopen(a)
            }), k.addEventListener("close", function (a) {
                g.onclose(a)
            }), k.addEventListener("connecting", function (a) {
                g.onconnecting(a)
            }), k.addEventListener("message", function (a) {
                g.onmessage(a)
            }), k.addEventListener("error", function (a) {
                g.onerror(a)
            }), this.addEventListener = k.addEventListener.bind(k), this.removeEventListener = k.removeEventListener.bind(k), this.dispatchEvent = k.dispatchEvent.bind(k), this.open = function (b) {
                h = new WebSocket(g.url, c || []), b || k.dispatchEvent(l("connecting")), (g.debug || a.debugAll) && console.debug("ReconnectingWebSocket", "attempt-connect", g.url);
                var d = h, e = setTimeout(function () {
                    (g.debug || a.debugAll) && console.debug("ReconnectingWebSocket", "connection-timeout", g.url), j = !0, d.close(), j = !1
                }, g.timeoutInterval);
                h.onopen = function () {
                    clearTimeout(e), (g.debug || a.debugAll) && console.debug("ReconnectingWebSocket", "onopen", g.url), g.protocol = h.protocol, g.readyState = WebSocket.OPEN, g.reconnectAttempts = 0;
                    var d = l("open");
                    d.isReconnect = b, b = !1, k.dispatchEvent(d)
                }, h.onclose = function (c) {
                    if (clearTimeout(e), h = null, i) g.readyState = WebSocket.CLOSED, k.dispatchEvent(l("close")); else {
                        g.readyState = WebSocket.CONNECTING;
                        var d = l("connecting");
                        d.code = c.code, d.reason = c.reason, d.wasClean = c.wasClean, k.dispatchEvent(d), b || j || ((g.debug || a.debugAll) && console.debug("ReconnectingWebSocket", "onclose", g.url), k.dispatchEvent(l("close")));
                        var e = g.reconnectInterval * Math.pow(g.reconnectDecay, g.reconnectAttempts);
                        setTimeout(function () {
                            g.reconnectAttempts++, g.open(!0)
                        }, e > g.maxReconnectInterval ? g.maxReconnectInterval : e)
                    }
                }, h.onmessage = function (b) {
                    (g.debug || a.debugAll) && console.debug("ReconnectingWebSocket", "onmessage", g.url, b.data);
                    var c = l("message");
                    c.data = b.data, k.dispatchEvent(c)
                }, h.onerror = function (b) {
                    (g.debug || a.debugAll) && console.debug("ReconnectingWebSocket", "onerror", g.url, b), k.dispatchEvent(l("error"))
                }
            }, 1 == this.automaticOpen && this.open(!1), this.send = function (b) {
                if (h) return (g.debug || a.debugAll) && console.debug("ReconnectingWebSocket", "send", g.url, b), h.send(b);
                throw"INVALID_STATE_ERR : Pausing to reconnect websocket"
            }, this.close = function (a, b) {
                "undefined" == typeof a && (a = 1e3), i = !0, h && h.close(a, b)
            }, this.refresh = function () {
                h && h.close()
            }
        }

        return a.prototype.onopen = function () {
        }, a.prototype.onclose = function () {
        }, a.prototype.onconnecting = function () {
        }, a.prototype.onmessage = function () {
        }, a.prototype.onerror = function () {
        }, a.debugAll = !1, a.CONNECTING = WebSocket.CONNECTING, a.OPEN = WebSocket.OPEN, a.CLOSING = WebSocket.CLOSING, a.CLOSED = WebSocket.CLOSED, a
    });
</script>
<script>
    var socket;
    $(function () {
        var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
        var ws_path = ws_scheme + '://' + window.location.host + "/global/";
        console.log("Connecting to " + ws_path);
        socket = new ReconnectingWebSocket(ws_path);
        socket.onmessage = function (message) {
            console.log("Got websocket message " + message.data);
            var data = JSON.parse(message.data);
            console.log(data)
            console.log(" got message end  ***************************************")
            var msgdiv = $("#messages")
            var msg = message.data + "<hr>"
            msgdiv.append(msg)
            if (data.message === 'joined') {
                $('#echo_bar').removeAttr('hidden')
            }

        };

        socket.onopen = function () {
            console.log("Connected to chat socket");
        };
        socket.onclose = function () {
            console.log("Disconnected from chat socket");
        };

        $('#join').click(function () {
            var token = get_token()
            socket.send(JSON.stringify({
                "command": "join",
                "token": token
            }));
            console.log("Join Request Sent");
        });

        $('#subscribe_organization').click(function () {
            var org_slug = $("#org_slug").val()
            socket.send(JSON.stringify({
                "command": "subscribe_organization",
                "organization_slug": org_slug
            }));
            $("#subscribed_to").text(org_slug);
            console.log("Subscribed");
        })

        $('#unsubscribe_organization').click(function () {
            socket.send(JSON.stringify({
                "command": "unsubscribe_organizations",
            }));
            $("#subscribed_to").text("Not Subscribed");
            console.log("Un Subscribed");
        })
    });
</script>
</html>
